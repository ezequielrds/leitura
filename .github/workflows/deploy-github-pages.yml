name: Deploy Branch Previews

on:
  push:
    branches-ignore:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Get branch name
        id: branch
        run: |
          # Remove 'refs/heads/' and replace '/' with '-' for branch name
          BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//-/g')
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch: $BRANCH_NAME"
        
      - name: Deploy branch preview
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          destination_dir: preview/${{ steps.branch.outputs.name }}
          keep_files: true
          
      - name: Comment preview URL
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            const branchName = '${{ steps.branch.outputs.name }}';
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/preview/${branchName}/`;
            
            console.log(`Preview URL: ${previewUrl}`);
            
            // Create a commit status
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: previewUrl,
              description: 'Preview dispon√≠vel',
              context: 'Branch Preview'
            });
